# 目标

HTTP 要确保它所承载的“货物”满足以下条件。

- 可以被正确地识别（通过  Content-Type 首部说明媒体格式，Content-Language  首部说明语言），以便浏览器和其他客户端能正确处理内容。
- 可以被正确地解包（通过  Content-Length 首部和  Content-Encoding  首部）。
- 是最新的（通过实体验证码和缓存过期控制）。
- 符合用户的需要（基于  Accept  系列的内容协商首部）。
- 在网络上可以快速有效地传输（通过范围请求、差异编码以及其他数据压缩方法）。
- 完整到达、未被篡改（通过传输编码首部和  Content-MD5  校验和首部）。

# 实体首部

## 实体长度

`Content-Length` 首部指示出报文中实体主题的字节大小。

- 如果主体内容进行了编码，则 `Content-Length` 指示编码后内容的字节大小。这种情况下由于没有原始内容字节大小信息，无法验证解码过程的完整性。

- ==除非使用了分块编码，否则 `Content-Length` 首部就是带有实体主题的报文必须使用的==。

如果缺少 `Content-Length` 首部会存在以下问题：

- 为了能够检测出服务器崩溃而导致的报文截尾。
  - 对缓存代理服务器来说尤其严重，因为它可能会存储不完整的内容并多次使用它来提供服务，所以缓存代理服务器通常不会为没有显式 `Content-Length` 首部的 HTTP 主体做缓存。
- 对共享持久连接的多个报文进行正确的分段。

### 确定实体主体长度的规则

下列规则按顺序应用

- 如果特定的 HTTP 报文类型中不允许带有主体，就忽略 Content-Length 首部。
  - 如：HEAD 响应。
  - 1XX、204 以及 304 响应。
- 如果报文中含有秒数传输编码的 Transfer-Encoding 首部（如果同时含有 Content-Length 首部，则 Content-Length 会被忽略），那实体就应由一个称为 “零字节块” 的特殊模式结束，除非报文已经因连接关闭而结束。
- 如果报文中含有 Content-Length 首部切不包含 Transfer-Encoding 首部，则 Content-Length 就是主体的长度。
- 如果报文使用了 multipart/byteranges 媒体类型，并且没有用 Content-Length 首部指出实体主题的长度，name多部分保证中的每个部分都要说明它自己的大小。
  - 这种多部分类型是唯一的一种自定界的实体主体类型。
- 如果上面的规则都不匹配，实体就在连接关闭的时候结束。
  - 实际上，只有服务器可以使用连接关闭来指示报文的结束。因为客户端这样做的话就无法接受服务器发回的响应了。

HTTP/1.1  规范中建议对于带有主体但没有  Content-Length  首部的请求，服务器如果无法确定报文的长度，就应当发送 400  Bad  Request  响应或  411  Length  Required 响应，后一种情况表明服务器要求收到正确的 Content-Length  首部。

## 实体摘要

服务器使用 Content-MD5 首部发送对实体主体运行 MD5 算法的结果。

- 只有产生响应的原始服务器可以计算并发送 Content-MD5 首部。中间代理和缓存不应当修改或添加这个首部。
- Content-MD5 首部是在对内容作了所有需要的内容编码之后，还没有做任何传输编码之前，计算出来的。

Content-MD5 除了检查报文的完整性之外，还可以当做散列表的关键字，用来快速定位稳定并消除不必要的重复内容存储。

## 媒体类型和字符集

Content-Type 首部字段说明了实体主体的 MIME 类型。

- MIME 类型由一个主媒体类型后面跟一条斜线以及一个子类型组成，子类型用于进一步描述媒体类型。如：text/plain、text/html、application/json 等。

- Content-Type 首部说明的是原始实体主体的媒体类型。

- **charset** 可选参数：它说明把实体中的比特转换为文本文件中的字符的方法。

  ```http
  Content-Type: text/html;charset=utf-8
  ```

## 实体编码

Accept-Enconding：客户端发送请求时可以将自己支持的内容编码方式列表放在请求的 Accept-Encoding 首部里，避免服务器采用客户端不支持的编码方式对实体主体进行编码。

Content-Encoding：服务器发送响应时如果对实体主体进行了编码，则需要在响应中添加 Content-Encoding，告诉客户端采用了那种编码。客户端才能使用该编码进行解码。

实体编码是对报文的主体进行的可逆变换，切编码方式是和实体主体内容的具体格式细节紧密相关的。

## 传输编码

Transfer-Encoding：传输编码是对整个报文进行的编码。目前只定义了 `chunked` 传输编码。

TE：和 Accept-Encoding 一样，客户端可以在发送请求时可以将自己支持的传输编码方式列表放在请求的 TE 首部里，避免服务器采用客户端不支持的编码方式对报文进行传输编码。