参考文章

- [缓存与数据库的数据一致性的解决方案](https://baijiahao.baidu.com/s?id=1630969175611754981&wfr=spider&for=pc)
- [谈谈缓存跟数据库的数据一致性问题](https://www.jianshu.com/p/a532962cb9e9)
- [redis系列之数据库与缓存数据一致性解决方案](https://www.cnblogs.com/cxxjohnson/p/8519616.html)

# 场景

## 场景一

当更新数据时，如更新某商品的库存，当前商品的库存是100，现在要更新为99，先更新数据库更改成99，然后删除缓存，发现删除缓存失败了，这意味着数据库存的是99，而缓存是100，这导致数据库和缓存不一致。

**解决方案**

这种情况应该是先删除缓存，然后在更新数据库，如果删除缓存失败，那就不要更新数据库，如果说删除缓存成功，而更新数据库失败，那查询的时候只是从数据库里查了旧的数据而已，这样就能保持数据库与缓存的一致性。

- 规避了更新数据库成功而删除缓存失败的情景。
- 但是并没有解决不一致的问题，因为在一个线程删除了缓存后还未将数据更新到数据库时，如果另一个线程此时获取商品库存信息则会重新从数据库中查询到未更新的数据然后放入缓存中。这样数据库与缓存的数据还是不一致。

# 解决方案

## 强一致性解决方案

- 如果数据更新频繁，而且不允许出现脏数据，这种情况下不适合进行缓存，直接依靠数据库的缓存。
- 在并发量不高的情况下，可以采取先删缓存再更新数据库的方式来解决一致性问题。
- 在并发量高的情况下
  - 读写分离：让更新数据的线程保证数据库与缓存中数据的一致性。
  - 

## 最终一致性解决方案

当业务对数据一致性的时效性要求不高时可以采用最终一致性解决方案。

### 设置缓存的过期时间

- 更新数据库之后直接更新缓存，而且不管缓存是否更新成功都成功返回。如果更新成功，那么后续的读请求都会从缓存中读取最新的数据；如果更新失败，那么就需要等待缓存中的旧数据过期后重新从数据库中获取并回填。
- 数据不一致的时长取决于缓存数据的过期时间长短。
- 实现简单，不依赖其它手段。

### 异步线程定时刷新缓存

- 